import shadow:io@Console;

class shadow:test@InterruptTest
{
	class ThreadSleepTestRunner is CanRun
	{
		public run() => ()
		{
			Console.printLine("waiting");
			Thread:Current.sleep(Time.fromSeconds(10));
			Console.printLine("done");
		}
	}
	
	class ThreadTestRunner is CanRun
	{
		public run() => ()
		{
			Console.printLine("I am " # Thread:Current->instance);

			var index = receive<int>(Thread:Current->main);
			Console.printLine(Thread:Current->instance # ": " # index);
			Thread:Current->main[index].join();

			Console.printLine("I should quit before reaching this" # Thread:Current->instance);
		}
	}

	public main(String[] args) => ()
	{
		spawn(ThreadSleepTestRunner:()); // 0
		
		spawn(ThreadTestRunner:()); // 1

		Thread current = Thread:Current->instance;

		send(0, current[1]);
		
		spawn(ThreadTestRunner:()); // 2
		send(1, current[2]);
		
		Thread:Current.sleep(Time.fromSeconds(4));
		current[1].interrupt();
		Console.printLine("end");
		
		try {
			current[2].join();
		} catch(ThreadException e) {
			if(e->actual is InterruptedException) {
				Console.printLine("InterruptedException thrown");
			} else {
				throw e;
			}
		}
		
		var now = Time.epochNow();
		current[0].join(Time.fromSeconds(1));
		now = Time.epochNow() - now;
		Console.printLine(now->seconds);
	}
}