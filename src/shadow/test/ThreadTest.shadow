import shadow:io@Console;

class shadow:test@ThreadTest
{
	class ThreadTestRunner is CanRun
	{
		public run() => ()
		{
			var id = CurrentThread->id;
			CurrentThread.sleep(id * 50);
			Console.printLine(CurrentThread->name);
			
			if(id == 4) {
				spawn(ThreadTestRunner:()).join(); // Thread#5; throws from Thread#6
			}
			else if(id == 5) {
				Console.printLine(CurrentThread->parent->id == 4);
				Console.printLine(CurrentThread->main->id == CurrentThread->parent->parent->id);
				
				spawn(ThreadTestRunner:()).join(); // Thread#6; throws from Thread#8
			}
			else if(id == 6) {
				spawn(ThreadTestRunner:()); // Thread#7; does not throw until joined
				spawn(ThreadTestRunner:()).join(); // Thread#8; throws and propagates
			}
			
			if(id > 2) {
				throw Exception:create("from " # CurrentThread->name);
			}
		}
	}

	public main(String[] args) => ()
	{
		var runner = ThreadTestRunner:create();
		runner.run(); // print main

		nullable var threads = Thread:null[4];
		for (int i = 0; i < threads->size; i += 1) {
			threads[i] = spawn(ThreadTestRunner:());
		}
		
		/*foreach(var x in CurrentThread.children()) {
			try {
				x.join();
			} catch(Exception e) {}
		}
	
		Console.printLine("First class children");
		foreach(var x in CurrentThread.children()) {
			Console.printLine(x->name);
		}

		Console.printLine("All children");
		foreach(var x in CurrentThread.children(true)) {
			Console.printLine(x->name);
		}*/
		// if we do not join here, Shadow should join on all threads
	}
}